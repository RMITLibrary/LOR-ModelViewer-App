<!DOCTYPE html>
<html lang="en-AU">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' https://unpkg.com; style-src 'self' 'unsafe-inline'; frame-ancestors *;"
    />
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN" />
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"
    ></script>
    <script src="resize.js"></script>
    <style>
      .model-container {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%; /* Default 16:9 ratio */
      }
      model-viewer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
      }
      .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #666;
      }
      .error {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: #ff0000;
        padding: 20px;
        background: rgba(255, 0, 0, 0.1);
        border-radius: 5px;
      }
    </style>
    <script>
      // Check if model-viewer is supported
      function isModelViewerSupported() {
        return (
          "customElements" in window &&
          customElements.get("model-viewer") !== undefined
        );
      }

      // Show error message
      function showError(message) {
        const container = document.getElementById("model-container");
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = message;
        container.appendChild(errorDiv);
      }

      // Show loading message
      function showLoading() {
        const container = document.getElementById("model-container");
        const loadingDiv = document.createElement("div");
        loadingDiv.className = "loading";
        loadingDiv.textContent = "Loading 3D Model...";
        container.appendChild(loadingDiv);
      }

      // Load model-viewer script
      function loadModelViewer() {
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.type = "module";
          script.src =
            "https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js";
          script.onload = resolve;
          script.onerror = () =>
            reject(new Error("Failed to load model-viewer script"));
          document.head.appendChild(script);
        });
      }

      document.addEventListener("DOMContentLoaded", async function () {
        try {
          // Show loading state
          showLoading();

          // Load model-viewer if not already loaded
          if (!isModelViewerSupported()) {
            await loadModelViewer();
          }

          // Default configuration
          const defaults = {
            width: 16,
            height: 9,
            minZoom: 25,
            maxZoom: 200,
            fieldOfView: 45,
            minFieldOfView: 10,
            maxFieldOfView: 90,
            orbitSensitivity: 1,
            rotationSpeed: 30,
            autoRotate: true,
            shadowIntensity: 1,
            exposure: 1,
            environmentImage: "neutral",
          };

          // Sanitise numeric values
          function sanitiseNumber(value, min, max, defaultValue) {
            const num = parseFloat(value);
            if (isNaN(num)) return defaultValue;
            return Math.min(Math.max(num, min), max);
          }

          // Sanitise string values
          function sanitiseString(value, allowedValues, defaultValue) {
            if (!value || !allowedValues.includes(value)) return defaultValue;
            return value;
          }

          // Get and sanitise URL parameters
          const urlParams = new URLSearchParams(window.location.search);

          // Required parameters
          const modelUrl = urlParams.get("model");
          const title = urlParams.get("title");
          const description = urlParams.get("description");

          if (!modelUrl) {
            throw new Error("No model URL provided");
          }

          // Optional parameters with sanitisation
          const width = sanitiseNumber(
            urlParams.get("width"),
            1,
            100,
            defaults.width
          );
          const height = sanitiseNumber(
            urlParams.get("height"),
            1,
            100,
            defaults.height
          );
          const minZoom = sanitiseNumber(
            urlParams.get("minZoom"),
            10,
            100,
            defaults.minZoom
          );
          const maxZoom = sanitiseNumber(
            urlParams.get("maxZoom"),
            100,
            500,
            defaults.maxZoom
          );
          const fieldOfView = sanitiseNumber(
            urlParams.get("fieldOfView"),
            10,
            90,
            defaults.fieldOfView
          );
          const minFieldOfView = sanitiseNumber(
            urlParams.get("minFieldOfView"),
            5,
            45,
            defaults.minFieldOfView
          );
          const maxFieldOfView = sanitiseNumber(
            urlParams.get("maxFieldOfView"),
            45,
            120,
            defaults.maxFieldOfView
          );
          const orbitSensitivity = sanitiseNumber(
            urlParams.get("orbitSensitivity"),
            0.1,
            5,
            defaults.orbitSensitivity
          );
          const rotationSpeed = sanitiseNumber(
            urlParams.get("rotationSpeed"),
            0,
            360,
            defaults.rotationSpeed
          );
          const autoRotate = urlParams.get("autoRotate") !== "false";
          const shadowIntensity = sanitiseNumber(
            urlParams.get("shadowIntensity"),
            0,
            2,
            defaults.shadowIntensity
          );
          const exposure = sanitiseNumber(
            urlParams.get("exposure"),
            0,
            2,
            defaults.exposure
          );

          // Environment image options
          const allowedEnvironments = [
            "neutral",
            "legacy",
            "sunset",
            "dawn",
            "night",
            "warehouse",
            "forest",
            "apartment",
            "studio",
            "city",
            "park",
            "lobby",
          ];
          const environmentImage = sanitiseString(
            urlParams.get("environmentImage"),
            allowedEnvironments,
            defaults.environmentImage
          );

          // Set title if provided
          if (title) {
            document.title = decodeURIComponent(title);
          }

          // Validate model URL
          let validatedModelUrl;
          try {
            validatedModelUrl = new URL(modelUrl).toString();
          } catch (e) {
            throw new Error("Invalid model URL provided");
          }

          // Create model-viewer element
          const modelViewer = document.createElement("model-viewer");

          // Set all attributes
          modelViewer.setAttribute("id", "model-viewer");
          modelViewer.setAttribute("camera-controls", "");
          modelViewer.setAttribute("auto-rotate", autoRotate);
          modelViewer.setAttribute("shadow-intensity", shadowIntensity);
          modelViewer.setAttribute("exposure", exposure);
          modelViewer.setAttribute("environment-image", environmentImage);
          modelViewer.setAttribute("ar", "");
          modelViewer.setAttribute("ar-modes", "webxr scene-viewer quick-look");
          modelViewer.setAttribute("ar-scale", "fixed");
          modelViewer.setAttribute("ar-placement", "floor");
          modelViewer.setAttribute("min-camera-orbit", `auto auto ${minZoom}%`);
          modelViewer.setAttribute("max-camera-orbit", `auto auto ${maxZoom}%`);
          modelViewer.setAttribute("camera-orbit", "0deg 75deg 105%");
          modelViewer.setAttribute("field-of-view", `${fieldOfView}deg`);
          modelViewer.setAttribute("min-field-of-view", `${minFieldOfView}deg`);
          modelViewer.setAttribute("max-field-of-view", `${maxFieldOfView}deg`);
          modelViewer.setAttribute("interpolation-decay", "200");
          modelViewer.setAttribute("touch-action", "pan-y pinch-zoom");
          modelViewer.setAttribute("interaction-prompt", "auto");
          modelViewer.setAttribute("interaction-prompt-style", "basic");
          modelViewer.setAttribute("interaction-prompt-threshold", "0");
          modelViewer.setAttribute("orbit-sensitivity", orbitSensitivity);
          modelViewer.setAttribute(
            "rotation-per-second",
            `${rotationSpeed}deg`
          );
          modelViewer.setAttribute("src", validatedModelUrl);

          // Add error handling for model loading
          modelViewer.addEventListener("error", (error) => {
            showError("Failed to load 3D model: " + error.message);
          });

          // Clear loading state and add viewer
          const container = document.getElementById("model-container");
          container.innerHTML = "";
          container.appendChild(modelViewer);

          // Set aspect ratio
          const ratio = (height / width) * 100;
          container.style.paddingBottom = `${ratio}%`;
        } catch (error) {
          showError(error.message);
        }
      });
    </script>
  </head>
  <body style="margin: 0; padding: 0">
    <div id="model-container" class="model-container"></div>
  </body>
</html>
